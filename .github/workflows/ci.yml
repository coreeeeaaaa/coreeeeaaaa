name: Core CI

on: [push, pull_request]

jobs:
  test_policies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x ./opa
      - name: Run OPA Tests
        run: ./opa test policy/ -v

  test_packages:
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install Dependencies
        run: npm install
      - name: Run All Package Tests
        run: npm test --workspaces
      - name: Audit Stubs
        run: npx ts-node scripts/audit-stubs.ts
      - name: Generate Hashes
        id: hash
        run: |
          echo "hashes=$(npm pack --dry-run --json | jq -r '.[] | @base64')" >> $GITHUB_OUTPUT

  provenance:
    needs: test_packages
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.10.0
    with:
      base64-subjects: "${{ needs.test_packages.outputs.hashes }}"

  rekor:
    needs: provenance
    runs-on: ubuntu-latest
    steps:
      - name: Upload to Rekor
        run: |
          echo "Uploading provenance to Rekor transparency log..."
          # Assuming sigstore CLI is available or install
          # sigstore sign --rekor-url https://rekor.sigstore.dev --artifact <artifact> --provenance <provenance>

  budget_gate:
    needs: test_packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x ./opa
      - name: Ensure artifacts budget
        run: |
          mkdir -p artifacts/budget
          mkdir -p artifacts/gates/budget
      - name: Run OPA budget gate
        env:
          BUDGET: 100
          OPA_BIN: ./opa
        run: npm run opa-check

  quality_gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install Dependencies
        run: npm install
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x ./opa
          sudo mv ./opa /usr/local/bin/opa
      - name: Build
        run: npm run build --workspaces
      - name: Test
        run: npm run test --workspaces
      - name: OPA Check
        run: npm run opa-check
      - name: Trivy FS scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2.3.0
